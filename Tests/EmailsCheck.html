<iframe src="" frameborder="0"></iframe>
<!doctype html>
<html lang="en">
<!--
This version of the SP Mass deletion tool for users is adapted to work with most versions of SP 2010 and 2013
It uses asynchronous requests
-->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mass Deletion 2010-2013</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>

    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.0/js/materialize.min.js"></script>

    <link rel="stylesheet" href="https://googledrive.com/host/0B05gvY7cupTtTnJfX2I1XzNtdkE/main.css">
    <link rel="stylesheet" href="https://googledrive.com/host/0B05gvY7cupTtTnJfX2I1XzNtdkE/normalize.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.7.1/modernizr.min.js"></script>
    <script type="text/javascript" src="https://googledrive.com/host/0B05gvY7cupTteG90ejJhVllWZ1k/jquery.SPServices.min.js"></script>
    <script type="text/javascript" src="https://googledrive.com/host/0B05gvY7cupTteG90ejJhVllWZ1k/sharepointplus.js"></script>
    <script type="text/javascript" src="libraries/2.2/sheetjs.all.min.js"></script>
    <script type="text/javascript" src="libraries/2.2/excelplus-2.2.min.js"></script>
    <script type="text/javascript" src="libraries/zeroclipboard-2.2.0/dist/ZeroClipboard.js"></script>
    <script type="text/javascript" src="js/User.js"></script>
    <script type="text/javascript" src="js/massDelete2.js"></script>
    <script type="text/javascript" src="js/Group.js"></script>
    <script type="text/javascript" src="js/Site.js"></script>
    <script type="text/javascript" src="js/generateMatrix.js"></script>

    <style>
        #wrapper{
            width: 70%;
            margin: auto;
        }
        #valid, #invalid{
            display: inline-block;
            width: 40%;
        }
        .hidden{
            display: none;
        }
        .permission-box{
            display: inline-block;
            width: 45%;
            margin: auto;
            vertical-align: top;
        }
        p{
            cursor: pointer;
        }
        ul > li{
            width: 20%;
            text-align: center;
        }
        ol{
            border: 1px solid black;
        }
        select{
            display: block;
            height: 100%;
            widows: 100%;
        }
    </style>
</head>

<body>

    

    <div id='wrapper'>
        <nav id='navigation'>
            <ul>
                <li class='home'>Home</li>
                <li class='mass-delete'>Mass Delete</li>
                <li class='add-delete'>Add & Delete User(s)</li>
                <li class='copy-permissions'>Copy Permissions</li>
                <li class='generate-matrix'>Generate Matrix</li>
            </ul>
        </nav>
        <section id='home'>
            HOME
        </section>
        <section id='mass-delete' class='hidden'>
            <div>
                <object id='file-object'></object>
            </div>
            <div id='valid'>
                <p>valid users</p>
                <ol id='valid-list'>
                </ol>
            </div>
            <div id='invalid'>
                <p>Invalid users</p>
                <ol id='invalid-list'>
                </ol>
                <button id='d_clip_button'  data-clipboard-target='invalid-list' data-clipboard-text='Default clipboard text from attribute' title='Click me to copy to clipboard.'> Copy selection </button>
            </div>
            <button id='delete-users'>Delete Users</button>
        </section>

        <section id='add-delete' class='hidden'>
             <div>
                <span>
                    <input id='emails' type='text' placeholder='Enter email' style='border: 1px solid black'/>
                </span>
                <span>
                    <button id='search-permissions' type='submit'>Search</button>
                </span>
            </div>
             <div class='permission-box'>
                <ol id='all-groups' class='collapsible' data-collapsible='accordion'></ol>
            </div>
             <div class='permission-box'>
                <ol id='user-groups' class='collapsible' data-collapsible='accordion'></ol>
            </div>
          
        </section>

        <section id='copy-permissions' class='hidden'>
           
           
        </section>

        <section id='generate-matrix' class='hidden'>
            <button id='matrix'>Generate Matrix</button>
        </section>

    </div>
   

   


    <script type="text/javascript">        
        //One access
        //permission matrix
        var sites = [];
        var matrixSites = [];
        var groups = []; 
        var usersInGroup = [];
        var ep = new ExcelPlus();
        var currentSection = 'home';

        $('#navigation').on('click', function(ev){
            if (ev.target.nodeName == 'LI'){
                $('#' + currentSection).addClass('hidden');
                currentSection = ev.target.className;
                $('#' + ev.target.className).removeClass('hidden');
            }
        });
       
         $('#matrix').click(function(){
             if (!!window.Worker){
                var worker = new Worker('js/getSitesInfo.js');
                 worker.onmessage = function(e){
                    
                    matrixSites = e.data[0];
                    groups = e.data[1];
                    generateExelFile(matrixSites, groups);
                }
                worker.postMessage([SITEENV, 'matrix']);
            }
        });
             




         //UAM - ability to add single/multiple user/users in different groups

        sites = getSites(SITEENV);

       
        var ol = document.getElementById('all-groups');

        for (var i = 0; i < sites.length; i++){
            var li = document.createElement('li');
            li.id = sites[i].id;
            var siteName = document.createElement('h6');
            siteName.innerHTML = sites[i].getName();
            siteName.className = 'collapsible-header';
            li.appendChild(siteName);

            ol.appendChild(li);
        }

        ol.addEventListener('click', function(ev){

            if (ev.target.nodeName == 'H6'){
                var id = ev.target.parentNode.id;

                while(ev.target.parentNode.childNodes.length > 1){
                    ev.target.parentNode.removeChild(ev.target.parentNode.lastChild);
                }

                if (!!ev.target.parentNode.className.match('active')){
                    sites[id].setGroups();
                    var groups = sites[id].getGroups();
                    for (var j = 0; j < groups.length; j++){
                        var groupName = $('<div>',{
                            class: 'collapsible-body group',
                            css: {
                                display: 'block',
                                position: 'relative'
                            }
                        });
                        var header = $('<span>',{
                            text: groups[j].getName(),
                            css: {
                                cursor: 'pointer'
                            }
                        });

                        var addRemoveUser = $('<a>',{
                            id: groups[j].getName(),
                            href: '#',
                            html: $('<img>',{
                                src: 'pics/add.jpg',
                                width: '20px',
                                height: '20px',
                                alt: 'Add'
                            }),
                            css: {
                                position: 'absolute',
                                right: '20px'
                            },
                            click: function(){
                                var userEmails = $('#emails').val().split(';');
                                    for(var email in userEmails){
                                        var user = new User();
                                        user.setEmail(userEmails[email]);
                                        user.setInfoByEmail();
                                        user.addToGroup(this.id);
                                    }
                                }
                        });

                        // var removeUser = $('<a>',{
                        //     href: '#',
                        //     html: $('<img>',{
                        //         src: 'pics/remove.jpg',
                        //         width: '20px',
                        //         height: '20px',
                        //         alt: 'Remove'
                        //     }),
                        //     css: {
                        //         position: 'absolute',
                        //         right: '0'
                        //     },
                        //     click: function(){
                        //          var userEmails = $('#usersInput').val().split(';');
                        //                 for(var email in userEmails){
                        //                     var user = new User();
                        //                     user.setEmail(userEmails[email]);
                        //                     getUserInfoByEmail(user);
                        //                     removeUserFromGroup(ev.target.innerHTML, user);
                        //                 }
                        //             }
                        // });
                        groupName.append(header);
                        groupName.append(addRemoveUser);
                        ev.target.parentNode.appendChild(groupName[0]);
                    }
                } 
            }

        }, false);
        
           //copy permissions

        function showPermissions(){
             // $('#all-groups').html('');
            $('#user-groups').html('');
            var emails = $('#emails').val().split(';');
            var user = new User();
            user.setEmail(emails[0]);
            user.setInfoByEmail();
            user.setGroups();

            for(var i = 0; i < user.getGroups().length; i++){
                var group = $('<li>',{
                    html: $('<h6>',{
                        text: user.getGroups()[i]
                    })
                });
                $('#user-groups').append(group);
            }
        }

        $('#emails').on('keypress', function(ev){
            console.log(ev.keyCode)
            if (ev.keyCode == 59){
                 console.log(this.value);
            }
           
        })
        $('#search-permissions').on('click', function(){
            showPermissions();
        });
        



    </script>
</body>
</html>
