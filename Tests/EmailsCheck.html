<iframe src="" frameborder="0"></iframe>
<!doctype html>
<html lang="en">
<!--
This version of the SP Mass deletion tool for users is adapted to work with most versions of SP 2010 and 2013
It uses asynchronous requests
-->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mass Deletion 2010-2013</title>
    <script type="text/javascript" src="https://googledrive.com/host/0B05gvY7cupTteG90ejJhVllWZ1k/jquery.js"></script>

    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://googledrive.com/host/0B05gvY7cupTtTnJfX2I1XzNtdkE/main.css">
    <link rel="stylesheet" href="https://googledrive.com/host/0B05gvY7cupTtTnJfX2I1XzNtdkE/normalize.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.7.1/modernizr.min.js"></script>
    <script type="text/javascript" src="https://googledrive.com/host/0B05gvY7cupTteG90ejJhVllWZ1k/jquery.SPServices.min.js"></script>
    <script type="text/javascript" src="https://googledrive.com/host/0B05gvY7cupTteG90ejJhVllWZ1k/sharepointplus.js"></script>
    <script type="text/javascript" src="libraries/2.2/sheetjs.all.min.js"></script>
    <script type="text/javascript" src="libraries/2.2/excelplus-2.2.min.js"></script>
    <script type="text/javascript" src="libraries/zeroclipboard-2.2.0/dist/ZeroClipboard.js"></script>
    <script type="text/javascript" src="js/User.js"></script>
    <script type="text/javascript" src="js/massDelete2.js"></script>
    <script type="text/javascript" src="js/Group.js"></script>
    <script type="text/javascript" src="js/Site.js"></script>
    <script type="text/javascript" src="js/generateExel.js"></script>
    <style>
        #wrapper{
            width: 70%;
            margin: auto;
        }
        ol{
            border: 1px solid black;

        }
        #valid, #invalid{
            display: inline-block;
            width: 40%;
        }
        p{
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div>
            <object id="file-object"></object>
        </div>
        <div id="valid">
            <p>valid users</p>
            <ol id="valid-list">
            </ol>
        </div>
        <div id="invalid">
            <p>Invalid users</p>
            <ol id="invalid-list">
            </ol>
            <button id="d_clip_button"  data-clipboard-target='invalid-list' data-clipboard-text='Default clipboard text from attribute' title='Click me to copy to clipboard.'> Copy selection </button>
        </div>
        <button id="delete-users">Delete Users</button>
    </div>
   
    <script type="text/javascript">        
        //One access
        //check group permissions

        function getSites(){
            var dfd = $.Deferred();

             $().SPServices({
                operation: 'GetAllSubWebCollection',
                completefunc: function(xData) {
                    dfd.resolve(
                        $(xData.responseXML).find("Webs > Web").each(function() {
                            var $node = $(this);
                            var site = new Site($node.attr('Title'), $node.attr('Url'));
                            sites.push(site);
                        })
                    )
                }
            });
             return dfd.promise();
        };

        var sites = [];
        var groups = []; 
        var usersInGroup = [];
        var ep = new ExcelPlus();
        ep.createFile('test');
        
        var button = document.createElement('button');
        button.innerHTML = 'Get Matrix';
        button.id = 'matrix';
        document.body.appendChild(button);


        getSites().done(function(){

            groups = [];
            var permissionMatrix = document.createElement('table');
            permissionMatrix.style.width = (sites.length + 1) * 200 + 'px';
            var row1 = document.createElement('tr');
            permissionMatrix.appendChild(row1);
            var cell1 = document.createElement('th');
            row1.appendChild(cell1);

            for(var i = 0; i < sites.length; i++){
                var site = document.createElement('th');
                site.innerHTML = sites[i].name;
                row1.appendChild(site);

                for(var j = 0; j < sites[i].groups.length; j++){
                    groups.push(sites[i].groups[j]);
                }
            }

            for (var i = 0; i < groups.length; i++){
                groups[i].url = [groups[i].url];
                groups[i].permissions = [groups[i].permissions];

                for (var j = i + 1; j < groups.length; j++){
                   
                    if (groups[i].name == groups[j].name){
                        
                        groups[i].url.push(groups[j].url);
                        groups[i].permissions.push(groups[j].permissions);
                        groups.splice(j, 1);
                        j--;
                    } 
                }
            }


            for (var i = 0; i < groups.length; i++){
                var row = document.createElement('tr');
                var groupName = document.createElement('th');
                groupName.innerHTML = groups[i].name;
                row.appendChild(groupName);
                for (var j = 0; j < sites.length; j++){

                    var cell = document.createElement('td');
                    cell.innerHTML = '';
                    for (var k = 0; k < groups[i].url.length; k++){
                        if (sites[j].url == groups[i].url[k]){
                            var text = '';
                            for(var p = 0; p < groups[i].permissions[k].length; p++){
                                switch (groups[i].permissions[k][p]){
                                    case 'Read':
                                        cell.style.background = 'purple';
                                        cell.style.color = 'white';
                                        break;
                                    case 'Contribute':
                                        cell.style.background = 'green';
                                        cell.style.color = 'white';
                                        break;
                                    case 'Owners Full Control':
                                        cell.style.background = 'maroon';
                                        cell.style.color = 'white';
                                        break;
                                }
                                text += groups[i].permissions[k][p] + '<br/>'
                            }
                            cell.innerHTML = text;
                            if (cell.innerHTML == 'Limited Access<br>'){
                                cell.style.background = 'yellow';
                            }
                        }
                    }
                    row.appendChild(cell)
                }
                permissionMatrix.appendChild(row);
            } 

            document.body.appendChild(permissionMatrix);


            $('tr').css('height','7em');
            $('th').css('width','200px');
            $('td').css('border','1px solid black');
            $('td').css('text-align','center');

            $('#matrix').click(function(){
                generateExelFile(sites, groups);
            });
          
        });


       


        var matrix = document.createElement('table');
        for(var i = 0; i < sites.length; i++){
            var row = document.createElement('tr');
            var siteName = document.createElement('td');
            siteName.innerHTML = sites[i].name;
            row.appendChild(siteName);
            for (var j = 0; j < sites[i].groups.length; j++){
                var groupName = document.createElement('td');
                groupName.innerHTML = sites[i].groups[j].name + '<br/>';
                for (var p = 0; p < sites[i].groups[j].permissions.length; p++){
                    var perm = document.createElement('span');
                    perm.style.color = 'red';
                    perm.innerHTML = sites[i].groups[j].permissions[p] + '<br/>';
                    groupName.appendChild(perm);
                }
                row.appendChild(groupName);
            }
            matrix.appendChild(row);
        };

        document.body.appendChild(matrix);       

        var userMatrix = document.createElement('table');
        for (var i = 0; i < groups.length; i++){
            var row = document.createElement('tr');
            var groupName = document.createElement('td');
            groupName.innerHTML = groups[i].name;
            row.appendChild(groupName);
            for(var j = 0; j < groups[i].users.length; j++){
                var user = document.createElement('td');
                user.style.color = 'blue';
                user.innerHTML = groups[i].users[j].getName();
                row.appendChild(user);
            }
            userMatrix.appendChild(row);
        }

        document.body.appendChild(userMatrix);

    </script>
</body>

</html>
